#!/bin/bash
# scripts/setup_airflow_python311_uv.sh
set -e

PROJECT_ROOT=$(pwd)
AIRFLOW_HOME="$PROJECT_ROOT/airflow_config"
VENV_PATH="$PROJECT_ROOT/.venv"

echo "üå™Ô∏è Configurando Apache Airflow con Python 3.11 y UV..."
echo "üìÅ Proyecto: $PROJECT_ROOT"
echo "üå™Ô∏è Airflow Home: $AIRFLOW_HOME"
echo ""

# ==========================================
# 1. VERIFICAR/INSTALAR UV
# ==========================================

echo "‚ö° Verificando UV (ultrafast Python package installer)..."

if ! command -v uv &> /dev/null; then
    echo "üì¶ Instalando UV..."
    
    # Detectar sistema operativo e instalar UV
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        if command -v brew &> /dev/null; then
            brew install uv
        else
            curl -LsSf https://astral.sh/uv/install.sh | sh
            export PATH="$HOME/.cargo/bin:$PATH"
        fi
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        # Linux
        curl -LsSf https://astral.sh/uv/install.sh | sh
        export PATH="$HOME/.cargo/bin:$PATH"
    else
        echo "‚ùå Error: Sistema operativo no soportado para UV"
        echo "üí° Instala UV manualmente desde https://github.com/astral-sh/uv"
        exit 1
    fi
    
    # Recargar PATH
    source ~/.bashrc 2>/dev/null || source ~/.zshrc 2>/dev/null || true
fi

# Verificar UV
if command -v uv &> /dev/null; then
    echo "‚úÖ UV disponible: $(uv --version)"
else
    echo "‚ùå Error: UV no se pudo instalar"
    exit 1
fi

# ==========================================
# 2. VERIFICAR/INSTALAR PYTHON 3.11
# ==========================================

echo ""
echo "üêç Verificando Python 3.11..."

# Funci√≥n para verificar si una versi√≥n de Python est√° disponible
check_python_version() {
    local python_cmd=$1
    if command -v $python_cmd &> /dev/null; then
        local version=$($python_cmd --version 2>&1 | grep -o "3\.11\.[0-9]*")
        if [[ -n "$version" ]]; then
            echo "‚úÖ Encontrado: $python_cmd (versi√≥n $version)"
            return 0
        fi
    fi
    return 1
}

# Buscar Python 3.11 en diferentes ubicaciones
PYTHON311_CMD=""

if check_python_version "python3.11"; then
    PYTHON311_CMD="python3.11"
elif check_python_version "python3"; then
    # Verificar si python3 es realmente 3.11
    version=$(python3 --version 2>&1 | grep -o "3\.11\.[0-9]*" || true)
    if [[ -n "$version" ]]; then
        PYTHON311_CMD="python3"
    fi
fi

# Si no se encuentra Python 3.11, instalarlo
if [[ -z "$PYTHON311_CMD" ]]; then
    echo "‚ùå Python 3.11 no encontrado. Instalando..."
    
    # Detectar sistema operativo
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        echo "üçé Detectado macOS"
        
        # Verificar si Homebrew est√° instalado
        if ! command -v brew &> /dev/null; then
            echo "üì¶ Instalando Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            
            # Agregar Homebrew al PATH
            if [[ -f "/opt/homebrew/bin/brew" ]]; then
                eval "$(/opt/homebrew/bin/brew shellenv)"
            elif [[ -f "/usr/local/bin/brew" ]]; then
                eval "$(/usr/local/bin/brew shellenv)"
            fi
        fi
        
        echo "üì¶ Instalando Python 3.11 con Homebrew..."
        brew install python@3.11
        
        # Verificar instalaci√≥n
        if [[ -f "/opt/homebrew/bin/python3.11" ]]; then
            PYTHON311_CMD="/opt/homebrew/bin/python3.11"
        elif [[ -f "/usr/local/bin/python3.11" ]]; then
            PYTHON311_CMD="/usr/local/bin/python3.11"
        else
            echo "‚ùå Error: No se pudo instalar Python 3.11"
            exit 1
        fi
        
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        # Linux
        echo "üêß Detectado Linux"
        
        # Ubuntu/Debian
        if command -v apt &> /dev/null; then
            echo "üì¶ Instalando Python 3.11 con apt..."
            sudo apt update
            sudo apt install -y software-properties-common
            sudo add-apt-repository -y ppa:deadsnakes/ppa
            sudo apt update
            sudo apt install -y python3.11 python3.11-venv python3.11-dev
            PYTHON311_CMD="python3.11"
            
        # CentOS/RHEL/Fedora
        elif command -v yum &> /dev/null || command -v dnf &> /dev/null; then
            echo "üì¶ Instalando Python 3.11 con yum/dnf..."
            if command -v dnf &> /dev/null; then
                sudo dnf install -y python3.11 python3.11-venv
            else
                sudo yum install -y python3.11 python3.11-venv
            fi
            PYTHON311_CMD="python3.11"
        else
            echo "‚ùå Error: Gestor de paquetes no soportado"
            echo "üí° Instala Python 3.11 manualmente desde https://www.python.org/downloads/"
            exit 1
        fi
    else
        echo "‚ùå Error: Sistema operativo no soportado"
        echo "üí° Instala Python 3.11 manualmente desde https://www.python.org/downloads/"
        exit 1
    fi
fi

echo "‚úÖ Python 3.11 disponible: $PYTHON311_CMD"

# Verificar versi√≥n final
PYTHON_VERSION=$($PYTHON311_CMD --version)
echo "üêç Versi√≥n: $PYTHON_VERSION"

# ==========================================
# 3. VERIFICAR/INSTALAR TMUX
# ==========================================

echo ""
echo "üì± Verificando tmux..."

if ! command -v tmux &> /dev/null; then
    echo "üì¶ Instalando tmux..."
    
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        if command -v brew &> /dev/null; then
            brew install tmux
        else
            echo "‚ùå Error: Homebrew necesario para instalar tmux en macOS"
            exit 1
        fi
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        # Linux
        if command -v apt &> /dev/null; then
            sudo apt update && sudo apt install -y tmux
        elif command -v yum &> /dev/null; then
            sudo yum install -y tmux
        elif command -v dnf &> /dev/null; then
            sudo dnf install -y tmux
        else
            echo "‚ùå Error: No se pudo instalar tmux autom√°ticamente"
            echo "üí° Instala tmux manualmente"
            exit 1
        fi
    fi
fi

if command -v tmux &> /dev/null; then
    echo "‚úÖ tmux disponible: $(tmux -V)"
else
    echo "‚ùå Error: tmux no se pudo instalar"
    exit 1
fi

# ==========================================
# 4. LIMPIAR INSTALACI√ìN ANTERIOR
# ==========================================

echo ""
echo "üßπ Limpiando instalaci√≥n anterior..."

# Eliminar virtual environment anterior
if [ -d "$VENV_PATH" ]; then
    echo "üóëÔ∏è Eliminando virtual environment anterior..."
    rm -rf "$VENV_PATH"
fi

# Eliminar configuraci√≥n anterior de Airflow
if [ -d "$AIRFLOW_HOME" ]; then
    echo "üóëÔ∏è Eliminando configuraci√≥n Airflow anterior..."
    rm -rf "$AIRFLOW_HOME"
fi

# ==========================================
# 5. CREAR VIRTUAL ENVIRONMENT CON UV
# ==========================================

echo ""
echo "‚ö° Creando virtual environment con UV y Python 3.11..."

# Crear virtual environment con UV
uv venv "$VENV_PATH" --python "$PYTHON311_CMD"

# Verificar que se cre√≥ correctamente
if [ ! -f "$VENV_PATH/bin/activate" ]; then
    echo "‚ùå Error: No se pudo crear virtual environment con UV"
    exit 1
fi

# Activar virtual environment
source "$VENV_PATH/bin/activate"

# Verificar que estamos usando Python 3.11
ACTIVE_PYTHON_VERSION=$(python --version)
echo "‚úÖ Virtual environment activo: $ACTIVE_PYTHON_VERSION"

# ==========================================
# 6. INSTALAR DEPENDENCIAS CON UV
# ==========================================

echo ""
echo "‚ö° Instalando dependencias con UV (ultrafast)..."

# Verificar que requirements.txt existe
if [ ! -f "$PROJECT_ROOT/requirements.txt" ]; then
    echo "‚ùå Error: requirements.txt no encontrado en $PROJECT_ROOT"
    echo "üí° Aseg√∫rate de tener un archivo requirements.txt en el proyecto"
    exit 1
fi

echo "üìã Usando requirements.txt: $PROJECT_ROOT/requirements.txt"

# Instalar dependencias con UV (mucho m√°s r√°pido que pip)
echo "‚¨áÔ∏è Instalando dependencias con UV..."
uv pip install -r "$PROJECT_ROOT/requirements.txt"

# Instalar tmux en el ambiente virtual (si es necesario como dependencia Python)
echo "üì± Verificando dependencias adicionales..."
uv pip install libtmux  # Para interactuar con tmux desde Python si es necesario

# Verificar instalaci√≥n de Airflow
echo "üîç Verificando instalaci√≥n de Airflow..."
if command -v airflow &> /dev/null; then
    echo "‚úÖ Airflow instalado correctamente"
    airflow version
else
    echo "‚ùå Error: Airflow no se instal√≥ correctamente"
    exit 1
fi

# ==========================================
# 7. CREAR ESTRUCTURA DE DIRECTORIOS
# ==========================================

echo ""
echo "üìÅ Creando estructura de directorios..."

mkdir -p "$AIRFLOW_HOME"
mkdir -p "$AIRFLOW_HOME/dags"
mkdir -p "$AIRFLOW_HOME/logs"
mkdir -p "$AIRFLOW_HOME/plugins"
mkdir -p "$PROJECT_ROOT/data/raw"
mkdir -p "$PROJECT_ROOT/data/processed/bronze"
mkdir -p "$PROJECT_ROOT/data/processed/silver"
mkdir -p "$PROJECT_ROOT/data/processed/gold"
mkdir -p "$PROJECT_ROOT/logs"

echo "‚úÖ Directorios creados:"
echo "  üìÅ $AIRFLOW_HOME"
echo "  üìÅ $PROJECT_ROOT/data"
echo "  üìÅ $PROJECT_ROOT/logs"

# ==========================================
# 8. CONFIGURAR AIRFLOW
# ==========================================

echo ""
echo "‚öôÔ∏è Configurando Airflow..."

# Establecer variable de entorno
export AIRFLOW_HOME="$AIRFLOW_HOME"

# Inicializar base de datos
echo "üóÑÔ∏è Inicializando base de datos de Airflow..."
airflow db init

# Crear usuario admin
echo "üë§ Creando usuario administrador..."
airflow users create \
    --username admin \
    --firstname Admin \
    --lastname User \
    --role Admin \
    --email admin@example.com \
    --password admin123 2>/dev/null || echo "‚ÑπÔ∏è Usuario admin ya existe"

# ==========================================
# 9. COPIAR DAGs
# ==========================================

echo ""
echo "üìã Copiando DAGs..."

# Verificar si los DAGs originales existen
if [ -f "$PROJECT_ROOT/airflow_config/dags/daily_pipeline_dag.py" ]; then
    cp "$PROJECT_ROOT/airflow_config/dags/daily_pipeline_dag.py" "$AIRFLOW_HOME/dags/"
    echo "‚úÖ daily_pipeline_dag.py copiado"
fi

if [ -f "$PROJECT_ROOT/airflow_config/dags/bronze_processing_dag.py" ]; then
    cp "$PROJECT_ROOT/airflow_config/dags/bronze_processing_dag.py" "$AIRFLOW_HOME/dags/"
    echo "‚úÖ bronze_processing_dag.py copiado"
fi

# Copiar todos los DAGs si existe el directorio
if [ -d "$PROJECT_ROOT/dags" ]; then
    cp -r "$PROJECT_ROOT/dags/"*.py "$AIRFLOW_HOME/dags/" 2>/dev/null || true
    echo "‚úÖ DAGs adicionales copiados desde /dags"
fi

# ==========================================
# 10. CREAR SCRIPTS DE GESTI√ìN MEJORADOS
# ==========================================

echo ""
echo "üìù Creando scripts de gesti√≥n mejorados..."

# Script para activar environment
cat > "$PROJECT_ROOT/activate_airflow.sh" << EOF
#!/bin/bash
# Script para activar el environment de Airflow con UV
export AIRFLOW_HOME="$AIRFLOW_HOME"
export PYTHONPATH="$PROJECT_ROOT/src:\$PYTHONPATH"
export PROJECT_ROOT="$PROJECT_ROOT"
source "$VENV_PATH/bin/activate"

echo "‚úÖ Environment de Airflow activado (UV)"
echo "üêç Python: \$(which python)"
echo "üå™Ô∏è Airflow: \$(which airflow)"
echo "‚ö° UV: \$(which uv)"
echo "üì± tmux: \$(which tmux)"
echo "üìÅ AIRFLOW_HOME: \$AIRFLOW_HOME"
echo ""
echo "üí° Comandos √∫tiles:"
echo "  airflow webserver --port 8080"
echo "  airflow scheduler"
echo "  airflow dags list"
echo "  uv pip install <package>  # Para instalar paquetes adicionales"
EOF

chmod +x "$PROJECT_ROOT/activate_airflow.sh"

# Script mejorado para iniciar Airflow con tmux
cat > "$PROJECT_ROOT/scripts/start_airflow_py311.sh" << EOF
#!/bin/bash
export AIRFLOW_HOME="$AIRFLOW_HOME"
cd "$PROJECT_ROOT"
source "$VENV_PATH/bin/activate"

echo "üå™Ô∏è Iniciando Airflow with Python 3.11 + UV + tmux..."
echo "üìÅ Proyecto: $PROJECT_ROOT"
echo "üêç Python: \$(python --version)"
echo "‚ö° UV: \$(uv --version)"
echo "üå™Ô∏è Airflow: \$(airflow version)"
echo "üì± tmux: \$(tmux -V)"
echo "üåê Web UI: http://localhost:8080"
echo "üë§ Login: admin / admin123"
echo ""

# Terminar sesiones existentes
echo "üõë Terminando sesiones tmux anteriores..."
tmux kill-session -t airflow-webserver 2>/dev/null || true
tmux kill-session -t airflow-scheduler 2>/dev/null || true

# Esperar un momento para limpieza
sleep 2

echo "üöÄ Iniciando servicios con tmux..."

# Crear sesi√≥n para webserver
tmux new-session -d -s airflow-webserver -c "$PROJECT_ROOT" \\
    "source '$VENV_PATH/bin/activate' && \\
     export AIRFLOW_HOME='$AIRFLOW_HOME' && \\
     export PYTHONPATH='$PROJECT_ROOT/src:\$PYTHONPATH' && \\
     echo 'üåê Iniciando Airflow Webserver...' && \\
     airflow webserver --port 8080"

# Crear sesi√≥n para scheduler
tmux new-session -d -s airflow-scheduler -c "$PROJECT_ROOT" \\
    "source '$VENV_PATH/bin/activate' && \\
     export AIRFLOW_HOME='$AIRFLOW_HOME' && \\
     export PYTHONPATH='$PROJECT_ROOT/src:\$PYTHONPATH' && \\
     echo 'üìÖ Iniciando Airflow Scheduler...' && \\
     sleep 5 && \\
     airflow scheduler"

# Esperar que los servicios inicien
echo "‚è≥ Esperando que los servicios inicien..."
sleep 10

echo ""
echo "‚úÖ Airflow iniciado correctamente!"
echo "üì± Sesiones tmux activas:"
echo "  üåê Webserver: tmux attach -t airflow-webserver"
echo "  üìÖ Scheduler: tmux attach -t airflow-scheduler"
echo ""
echo "üåê Acceso Web: http://localhost:8080"
echo "üë§ Usuario: admin"
echo "üîê Password: admin123"
echo ""
echo "üí° Comandos √∫tiles:"
echo "  üîç Ver estado: ./scripts/check_airflow_py311.sh"
echo "  üõë Parar servicios: ./scripts/stop_airflow.sh"
echo "  üì± Listar sesiones: tmux list-sessions"
echo "  üîÑ Reiniciar: ./scripts/restart_airflow.sh"
EOF

chmod +x "$PROJECT_ROOT/scripts/start_airflow_py311.sh"

# Script para parar Airflow
cat > "$PROJECT_ROOT/scripts/stop_airflow.sh" << EOF
#!/bin/bash
echo "üõë Parando servicios de Airflow..."

# Terminar sesiones tmux
tmux kill-session -t airflow-webserver 2>/dev/null && echo "‚úÖ Webserver parado" || echo "‚ÑπÔ∏è Webserver no estaba corriendo"
tmux kill-session -t airflow-scheduler 2>/dev/null && echo "‚úÖ Scheduler parado" || echo "‚ÑπÔ∏è Scheduler no estaba corriendo"

# Terminar procesos residuales
pkill -f "airflow webserver" 2>/dev/null || true
pkill -f "airflow scheduler" 2>/dev/null || true

echo "‚úÖ Servicios de Airflow detenidos"
EOF

chmod +x "$PROJECT_ROOT/scripts/stop_airflow.sh"

# Script para reiniciar Airflow  
cat > "$PROJECT_ROOT/scripts/restart_airflow.sh" << EOF
#!/bin/bash
echo "üîÑ Reiniciando Airflow..."
./scripts/stop_airflow.sh
sleep 3
./scripts/start_airflow_py311.sh
EOF

chmod +x "$PROJECT_ROOT/scripts/restart_airflow.sh"

# Script mejorado para verificar estado
cat > "$PROJECT_ROOT/scripts/check_airflow_py311.sh" << EOF
#!/bin/bash
export AIRFLOW_HOME="$AIRFLOW_HOME"
cd "$PROJECT_ROOT"

echo "üîç DIAGN√ìSTICO AIRFLOW CON PYTHON 3.11 + UV"
echo "==========================================="
echo "üìÅ Proyecto: $PROJECT_ROOT"
echo "üå™Ô∏è Airflow Home: $AIRFLOW_HOME"
echo ""

# Verificar herramientas
echo "üõ†Ô∏è Herramientas:"
command -v uv &> /dev/null && echo "  ‚úÖ UV: \$(uv --version)" || echo "  ‚ùå UV no disponible"
command -v tmux &> /dev/null && echo "  ‚úÖ tmux: \$(tmux -V)" || echo "  ‚ùå tmux no disponible"

# Verificar Python y ambiente
echo ""
echo "üêç Environment:"
if [ -f "$VENV_PATH/bin/activate" ]; then
    source "$VENV_PATH/bin/activate"
    echo "  ‚úÖ Virtual env activo (UV)"
    echo "  üêç Python: \$(python --version)"
    echo "  üìç Ubicaci√≥n: \$(which python)"
    
    if command -v airflow &> /dev/null; then
        echo "  ‚úÖ Airflow disponible"
        echo "  üìã Versi√≥n: \$(airflow version)"
        echo "  üìç Ubicaci√≥n: \$(which airflow)"
    else
        echo "  ‚ùå Airflow NO disponible"
    fi
else
    echo "  ‚ùå Virtual env no encontrado"
fi

echo ""
echo "üìÅ Archivos cr√≠ticos:"
[ -f "$AIRFLOW_HOME/airflow.db" ] && echo "  ‚úÖ airflow.db" || echo "  ‚ùå airflow.db"
[ -f "$AIRFLOW_HOME/airflow.cfg" ] && echo "  ‚úÖ airflow.cfg" || echo "  ‚ùå airflow.cfg"
[ -d "$AIRFLOW_HOME/dags" ] && echo "  ‚úÖ dags/" || echo "  ‚ùå dags/"

if [ -d "$AIRFLOW_HOME/dags" ]; then
    dag_count=\$(ls -1 "$AIRFLOW_HOME/dags"/*.py 2>/dev/null | wc -l)
    echo "  üìã DAGs encontrados: \$dag_count"
    
    if [ \$dag_count -gt 0 ]; then
        echo "  üìù Archivos DAG:"
        ls -la "$AIRFLOW_HOME/dags"/*.py 2>/dev/null | awk '{print "    " \$9}' || true
    fi
fi

echo ""
echo "üìã Procesos:"
webserver_pid=\$(pgrep -f "airflow webserver" 2>/dev/null || true)
scheduler_pid=\$(pgrep -f "airflow scheduler" 2>/dev/null || true)

if [ ! -z "\$webserver_pid" ]; then
    echo "  ‚úÖ Webserver (PID: \$webserver_pid)"
else
    echo "  ‚ùå Webserver NO corriendo"
fi

if [ ! -z "\$scheduler_pid" ]; then
    echo "  ‚úÖ Scheduler (PID: \$scheduler_pid)"
else
    echo "  ‚ùå Scheduler NO corriendo"
fi

echo ""
echo "üì± Sesiones tmux:"
if tmux has-session -t airflow-webserver 2>/dev/null; then
    echo "  ‚úÖ airflow-webserver"
else
    echo "  ‚ùå airflow-webserver"
fi

if tmux has-session -t airflow-scheduler 2>/dev/null; then
    echo "  ‚úÖ airflow-scheduler"
else
    echo "  ‚ùå airflow-scheduler"
fi

echo ""
echo "üåê Conectividad:"
if [ ! -z "\$webserver_pid" ]; then
    if curl -s http://localhost:8080 > /dev/null 2>&1; then
        echo "  ‚úÖ Web UI accesible en http://localhost:8080"
    else
        echo "  ‚ö†Ô∏è Web UI no responde (puede estar iniciando)"
    fi
else
    echo "  ‚ùå Web UI no disponible"
fi

echo ""
echo "üîë Credenciales:"
echo "  üë§ Usuario: admin"
echo "  üîê Password: admin123"

# Test de DAGs si Airflow est√° corriendo
if [ ! -z "\$webserver_pid" ] && [ ! -z "\$scheduler_pid" ]; then
    echo ""
    echo "üìã Estado de DAGs:"
    source "$VENV_PATH/bin/activate"
    export AIRFLOW_HOME="$AIRFLOW_HOME"
    timeout 10 airflow dags list 2>/dev/null | head -10 || echo "  ‚ö†Ô∏è Timeout o error conectando a la base de datos"
fi

echo ""
echo "üí° Comandos √∫tiles:"
echo "  üöÄ Iniciar: ./scripts/start_airflow_py311.sh"
echo "  üõë Parar: ./scripts/stop_airflow.sh"
echo "  üîÑ Reiniciar: ./scripts/restart_airflow.sh"
echo "  üì± Ver webserver: tmux attach -t airflow-webserver"
echo "  üìÖ Ver scheduler: tmux attach -t airflow-scheduler"
EOF

chmod +x "$PROJECT_ROOT/scripts/check_airflow_py311.sh"

# ==========================================
# 11. CONFIGURACI√ìN FINAL
# ==========================================

echo ""
echo "‚öôÔ∏è Configuraci√≥n final..."

# Crear archivo de variables de entorno mejorado
cat > "$PROJECT_ROOT/.airflow_env" << EOF
# Variables de entorno para Airflow con Python 3.11 + UV + tmux
export AIRFLOW_HOME="$AIRFLOW_HOME"
export PYTHONPATH="$PROJECT_ROOT/src:\$PYTHONPATH"
export PROJECT_ROOT="$PROJECT_ROOT"

# Para activar:
# source .airflow_env
# source .venv/bin/activate

# Herramientas disponibles:
# - uv: gestor de paquetes ultrarr√°pido
# - tmux: multiplexor de terminal  
# - airflow: orquestador de workflows
EOF

# Crear archivo .env para el proyecto
cat > "$PROJECT_ROOT/.env" << EOF
# Configuraci√≥n del proyecto
PROJECT_ROOT=$PROJECT_ROOT
AIRFLOW_HOME=$AIRFLOW_HOME
PYTHON_VERSION=3.11

# Configuraci√≥n de base de datos (SQLite por defecto)
AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=sqlite:///$AIRFLOW_HOME/airflow.db

# Configuraci√≥n de logging
AIRFLOW__LOGGING__LOGGING_LEVEL=INFO
AIRFLOW__LOGGING__BASE_LOG_FOLDER=$AIRFLOW_HOME/logs

# Configuraci√≥n de seguridad
AIRFLOW__WEBSERVER__SECRET_KEY=$(python -c "import secrets; print(secrets.token_urlsafe(32))")
EOF

# Verificar que todo funciona
echo "üîç Verificaci√≥n final..."
source "$VENV_PATH/bin/activate"
export AIRFLOW_HOME="$AIRFLOW_HOME"
airflow db check 2>/dev/null && echo "‚úÖ Base de datos OK" || echo "‚ö†Ô∏è Verificar base de datos"

# ==========================================
# 12. INSTRUCCIONES FINALES
# ==========================================

echo ""
echo "üéâ INSTALACI√ìN COMPLETADA CON PYTHON 3.11 + UV + TMUX"
echo "====================================================="
echo ""
echo "‚úÖ Resumen de herramientas instaladas:"
echo "  üêç Python: $PYTHON_VERSION"
echo "  ‚ö° UV: $(uv --version 2>/dev/null || echo 'disponible')"
echo "  üì± tmux: $(tmux -V 2>/dev/null || echo 'disponible')" 
echo "  üå™Ô∏è Airflow: $(airflow version 2>/dev/null || echo 'instalado')"
echo "  üìÅ Proyecto: $PROJECT_ROOT"
echo "  üóÇÔ∏è AIRFLOW_HOME: $AIRFLOW_HOME"
echo ""
echo "üöÄ PR√ìXIMOS PASOS:"
echo ""
echo "1. üìã Verificar instalaci√≥n completa:"
echo "   ./scripts/check_airflow_py311.sh"
echo ""
echo "2. üå™Ô∏è Iniciar Airflow (con tmux autom√°tico):"
echo "   ./scripts/start_airflow_py311.sh"
echo ""
echo "3. üåê Acceder a Web UI:"
echo "   http://localhost:8080"
echo "   üë§ Usuario: admin"
echo "   üîê Password: admin123"
echo ""
echo "4. ‚ö° Activar environment para desarrollo:"
echo "   ./activate_airflow.sh"
echo ""
echo "5. üì¶ Instalar paquetes adicionales:"
echo "   source ./activate_airflow.sh"
echo "   uv pip install <package_name>"
echo ""
echo "6. üîß Gesti√≥n de servicios:"
echo "   üõë Parar: ./scripts/stop_airflow.sh"
echo "   üîÑ Reiniciar: ./scripts/restart_airflow.sh"
echo "   üì± Ver logs webserver: tmux attach -t airflow-webserver"
echo "   üìÖ Ver logs scheduler: tmux attach -t airflow-scheduler"
echo ""
echo "üí° VENTAJAS DE ESTA CONFIGURACI√ìN:"
echo ""
echo "‚ö° UV (Ultra-fast Python package manager):"
echo "  ‚Ä¢ Instalaci√≥n de paquetes 10-100x m√°s r√°pida que pip"
echo "  ‚Ä¢ Resoluci√≥n de dependencias mejorada"
echo "  ‚Ä¢ Manejo inteligente de conflictos"
echo ""
echo "üì± tmux (Terminal multiplexer):"
echo "  ‚Ä¢ Servicios corriendo en background"
echo "  ‚Ä¢ Sesiones persistentes (sobreviven desconexiones SSH)"
echo "  ‚Ä¢ F√°cil acceso a logs en tiempo real"
echo "  ‚Ä¢ Gesti√≥n independiente de webserver y scheduler"
echo ""
echo "üå™Ô∏è Apache Airflow 2.9.3:"
echo "  ‚Ä¢ Compatible con Python 3.11"
echo "  ‚Ä¢ √öltima versi√≥n estable"
echo "  ‚Ä¢ Mejor rendimiento y caracter√≠sticas"
echo ""
echo "üìÅ Estructura de datos organizada:"
echo "  ‚Ä¢ /data/raw - Datos sin procesar"
echo "  ‚Ä¢ /data/processed/bronze - Datos limpios"
echo "  ‚Ä¢ /data/processed/silver - Datos enriquecidos"
echo "  ‚Ä¢ /data/processed/gold - Datos anal√≠ticos"
echo ""
echo "üîß COMANDOS DE TROUBLESHOOTING:"
echo ""
echo "Si hay problemas con tmux:"
echo "  tmux kill-server  # Reinicia tmux completamente"
echo "  tmux list-sessions  # Ver sesiones activas"
echo ""
echo "Si hay problemas con Airflow:"
echo "  source ./activate_airflow.sh"
echo "  airflow db reset  # Reinicia la base de datos (‚ö†Ô∏è borra datos)"
echo "  airflow db upgrade  # Actualiza esquema de BD"
echo ""
echo "Si hay problemas con UV:"
echo "  uv pip list  # Ver paquetes instalados"
echo "  uv pip install --upgrade <package>  # Actualizar paquete"
echo "  uv cache clean  # Limpiar cache de UV"
echo ""
echo "üîó RECURSOS √öTILES:"
echo ""
echo "üìö Documentaci√≥n:"
echo "  ‚Ä¢ Airflow: https://airflow.apache.org/docs/"
echo "  ‚Ä¢ UV: https://github.com/astral-sh/uv"
echo "  ‚Ä¢ tmux: https://github.com/tmux/tmux/wiki"
echo ""
echo "üéØ ¬°Tu pipeline de datos est√° listo para procesar informaci√≥n!"
echo "üöÄ Usa UV para instalar paquetes r√°pidamente"
echo "üì± Usa tmux para gestionar servicios de manera profesional"
echo ""
echo "üíù BONUS: Archivos creados para ti:"
echo "  üìã requirements.txt - Dependencias actualizadas y versionadas"
echo "  üîß activate_airflow.sh - Activaci√≥n r√°pida del environment"
echo "  üöÄ start_airflow_py311.sh - Inicio autom√°tico con tmux"
echo "  üõë stop_airflow.sh - Parada limpia de servicios"
echo "  üîÑ restart_airflow.sh - Reinicio r√°pido"
echo "  üîç check_airflow_py311.sh - Diagn√≥stico completo del sistema"
echo "  üìÑ .airflow_env - Variables de entorno"
echo "  üîê .env - Configuraci√≥n del proyecto"